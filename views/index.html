<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>평림댐 3D 모델링 테스트</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%
        }
    </style>
</head>
<body>
<script src="http://dreamplan7.cafe24.com/canvas2/js/three.js"></script>
<script src="http://dreamplan7.cafe24.com/canvas2/js/OrbitControls.js"></script>
<script src="http://dreamplan7.cafe24.com/canvas2/js/ColladaLoader.js"></script>
<script src="http://dreamplan7.cafe24.com/canvas2/js/Sky.js"></script>
<script src="http://dreamplan7.cafe24.com/canvas2/js/Water.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.js"
        integrity="sha512-Mcz+Mt8k23j06ycA5EJGfyXbtzB6xqEoJxjGftQQoed/zQzem9Lt21LRymjlcm+NUsbF0LOHgfdN8LO8GtKDOw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    // 장면
    const scene = new THREE.Scene();

    // GUI
    const gui = new dat.GUI();

    // // 텍스쳐 로드 및 높이파일 설정
    const loader = new THREE.TextureLoader();
    const height = loader.load('/static/height_black.jpg');

    height.warpS = height.wrapT = THREE.RepeatWrapping;
    const texture = loader.load('/static/texture.jpg');
    //
    // Geometry                                                    // (height, width, heightSeg., widthSeg.)
    const geometry = new THREE.PlaneBufferGeometry(2000, 2000, 128, 128) // segments 가 높을수록 더 세밀한 오브젝트 생성이 가능
    // const geometry_side = new THREE.PlaneBufferGeometry(3, 0.5, 1, 1)

    // Materials
    // 저수지 굴곡표현
    const meterial = new THREE.MeshStandardMaterial({
        color          : '0x000000',
        // map            : texture,
        displacementMap: height,
        wireframe: true,
        displacementScale: 500,
        alpha: false,
    });

    meterial.side = THREE.DoubleSide;

    // 양 옆 덮개 표현
    // const meterial_side = new THREE.MeshStandardMaterial({
    //     color: 'gray',
    //     map  : texture
    // });

    // Materials 객체 init
    const plane = new THREE.Mesh(geometry, meterial);
    plane
    // const plane_01 = new THREE.Mesh(geometry_side, meterial_side);
    // const plane_02 = new THREE.Mesh(geometry_side, meterial_side);
    // const plane_03 = new THREE.Mesh(geometry_side, meterial_side);
    // const plane_04 = new THREE.Mesh(geometry_side, meterial_side);

    // Materials 객체 위치 조정
    plane.rotation.x = -Math.PI / 2;
    // plane_01.position.set(0, 0.52, 1.488)
    // plane_02.position.set(0, 0.52, -1.51)
    // plane_03.position.set(1.5, 0.52, 0)
    // plane_04.position.set(-1.5, 0.52, 0)

    // Materials 더블

    // Materials 객체 회전 조정
    // plane_02.rotation.y = 3.15
    // plane_03.rotation.y = 1.565
    // plane_04.rotation.y = -1.565

    // 객체 추가
    scene.add(plane);
    // scene.add(plane_01);
    // scene.add(plane_02);
    // scene.add(plane_03);
    // scene.add(plane_04);
    //
    // // gui.add(plane.rotation, 'x').min(0).max(20);
    // // gui.add(plane.rotation, 'z').min(0).max(20);

    // const grounGeo = new THREE.PlaneGeometry(1000, 1000, 64, 64);
    //
    // let disMap = loader.load('/static/height_black_04.jpg');
    //
    // disMap.wrapS = disMap.wrapT = THREE.RepeatWrapping;
    // disMap.repeat.set(0);
    //
    // const groundMat = new THREE.MeshStandardMaterial({
    //     color: 0x000000,
    //     wireframe: true,
    //     displacementMap: disMap,
    //     displacementScale: 2
    // })
    //
    // groundMesh = new THREE.Mesh(grounGeo, groundMat);
    // scene.add(groundMesh);
    //
    // groundMesh.rotation.x = -Math.PI / 2;
    // groundMesh.position.y = -0.5;

    // 카메라 ( 카메라 수직 시야 각도, 가로세로 종횡비율, 시야거리 시작지점, 시야거리 끝지점 )
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2500);

    // 렌더러 정의 및 크기 지정, 문서에 추가
    const renderer = new THREE.WebGLRenderer({antialias: true, preserveDrawingBuffer: true});
    // renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setSize(640,480);
    document.body.appendChild(renderer.domElement);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFShadowMap;

    // const model;
    // const land;

    // const loader = new THREE.TextureLoader();
    // const loaderMesh = new THREE.ColladaLoader();

    // loaderMesh.load(
    //         'http://dreamplan7.cafe24.com/canvas/img/home.dae',
    //         function ( collada ){
    //           model = collada.scene;
    //           const i;
    //           for(i=0;i<model.children.length;++i)
    //             model.children[i].castShadow=true;
    //           model.rotation.x= -90 * ( Math.PI / 180 );
    //           model.rotation.z= -90 * ( Math.PI / 180 );
    //           model.position.set(0,3,0);
    //           scene.add( model );
    //         });
    //
    // loaderMesh.load(
    //         'http://dreamplan7.cafe24.com/canvas/dae/island2.dae',
    //         function ( collada ){
    //           land = collada.scene;
    //           loader.load(
    //                   'http://dreamplan7.cafe24.com/canvas/dae/rock05.jpg',
    //                   function ( texture ) {
    //                     land.children[0].material = new THREE.MeshStandardMaterial({map: texture});
    //                     land.children[0].castShadow=true;
    //                   }
    //           );
    //           land.scale.set(300,300,300);
    //           land.position.set(0,-50,50);
    //           land.rotation.x= -90 * ( Math.PI / 180 );
    //
    //           scene.add( land );
    //         });

    // 바닥
    // const floor;
    // floor = new THREE.Mesh(
    //         new THREE.BoxGeometry(10, 10, 10)
    // );
    // loader.load(
    //         'http://dreamplan7.cafe24.com/canvas/img/floor1.jpg',
    //         function ( texture ) {
    //           floor.material = new THREE.MeshStandardMaterial({map: texture});
    //           floor.material.map.repeat.x=3;
    //           floor.material.map.repeat.y=3;
    //           floor.material.map.wrapS=THREE.RepeatWrapping;
    //           floor.material.map.wrapT=THREE.RepeatWrapping;
    //         }
    // );
    // scene.add(floor);
    //
    // floor.position.set(0, -3, 0);
    // floor.receiveShadow=true;

    // 카메라 위치 조정
    camera.position.set(450, 550, 0);

    // 카메라 회전 앵글 조정
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    controls.minPolarAngle = Math.PI / -2;
    controls.maxPolarAngle = 1;

    // 카메라 줌 조정
    controls.minDistance = 550;
    controls.maxDistance = 1500;

    // 조명
    const light_base = new THREE.AmbientLight(0xf0f0f0); // soft white light
    scene.add(light_base);

    const light_sun = new THREE.DirectionalLight(0x808080, 1.0);
    light_sun.position.set( 200, 200, 300 );
    scene.add(light_sun);
    const shadowBlur = 10;
    light_sun.castShadow = true;
    light_sun.shadow.camera.left = -shadowBlur;
    light_sun.shadow.camera.right = shadowBlur;
    light_sun.shadow.camera.top = shadowBlur;
    light_sun.shadow.camera.bottom = -shadowBlur;

    // 수면
    const waterGeometry = new THREE.PlaneBufferGeometry(2000, 2000, 32, 32);

    const water = new THREE.Water(
            waterGeometry,
            {
                textureWidth   : 8,
                textureHeight  : 8,
                waterNormals   : new THREE.TextureLoader().load('http://dreamplan7.cafe24.com/canvas/img/waternormals.jpg', function (texture) {

                    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;

                }),
                alpha          : 1.0,
                sunDirection   : light_sun.position.clone().normalize(),
                sunColor       : 0xffffff,
                waterColor     : 0x001e0f,
                distortionScale: 1,
                fog            : scene.fog !== undefined
            }
    );

    // 수면 회전 및 위치
    water.rotation.x = -Math.PI / 2;
    water.position.set(0, 100, 0); // (x, y, z) 값이며 y 값으로 수면 높이 조정 max: 345

    // gui.add(water.rotation, 'x').min(0).max(20);
    // gui.add(water.rotation, 'y').min(0).max(20);
    // gui.add(water.rotation, 'z').min(0).max(20);

    scene.add(water);

    const sky = new THREE.Sky();

    sky.material.uniforms['turbidity'].value = 10;
    sky.material.uniforms['rayleigh'].value = 2;
    sky.material.uniforms['luminance'].value = 1;
    sky.material.uniforms['mieCoefficient'].value = 0.005;
    sky.material.uniforms['mieDirectionalG'].value = 0.8;

    const parameters = {
        distance   : 400,
        inclination: 0.1,
        azimuth    : 0.05
    };

    const cubeCamera = new THREE.CubeCamera(0.1, 1, 512);
    scene.background = cubeCamera.renderTarget;

    const theta = Math.PI * (parameters.inclination - 0.5);
    const phi = 2 * Math.PI * (parameters.azimuth - 0.5);

    light_sun.position.x = parameters.distance * Math.cos(phi);
    light_sun.position.y = parameters.distance * Math.sin(phi) * Math.sin(theta);
    light_sun.position.z = parameters.distance * Math.sin(phi) * Math.cos(theta);

    sky.material.uniforms['sunPosition'].value = light_sun.position.copy(light_sun.position);
    water.material.uniforms['sunDirection'].value.copy(light_sun.position).normalize();

    cubeCamera.update(renderer, sky);

    // ==========================
    // 초기화 부분 끝
    // ==========================

    const framesPerSecond = 144;

    // 에니메이션 효과를 자동으로 주기 위한 보조 기능입니다.
    const animate = function () {
        // 프레임 처리
        setTimeout(function () {
            requestAnimationFrame(animate);
        }, 24 / framesPerSecond);

        water.material.uniforms['time'].value += 0.5 / 60.0;

        // 랜더링을 수행합니다.
        renderer.render(scene, camera);
    };

    // animate()함수를 최초에 한번은 수행해주어야 합니다.
    animate();
</script>
</body>
</html>
